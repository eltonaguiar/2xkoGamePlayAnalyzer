<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2XKO Gameplay Analysis - Video Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .player-info {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .player-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 250px;
            margin: 10px;
        }
        
        .player-card img {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            border: 3px solid white;
            margin-bottom: 10px;
        }
        
        .player-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .player-card .position-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
        }
        
        .color-indicator {
            display: inline-block;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid white;
            margin: 5px;
        }
        
        .stats-section {
            padding: 20px;
            background: #f9f9f9;
            border-bottom: 2px solid #ddd;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .move-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .move-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .move-name {
            font-weight: bold;
            color: #333;
        }
        
        .move-count {
            color: #667eea;
        }
        
        .controls {
            padding: 20px;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .filter-btn:not(.active) {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .filter-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .video-section {
            padding: 30px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        video {
            width: 100%;
            display: block;
        }
        
        .annotation-overlay {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px;
            border-radius: 8px;
            display: none;
            border-left: 4px solid #ffd700;
        }
        
        .annotation-overlay.active {
            display: block;
        }
        
        .annotation-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .annotation-text {
            font-size: 1em;
            line-height: 1.6;
        }
        
        .damage-badge {
            display: inline-block;
            background: #f44336;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .damage-info {
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 3px solid #f44336;
        }
        
        .damage-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.95em;
        }
        
        .damage-label {
            font-weight: bold;
            color: #666;
        }
        
        .damage-value {
            color: #f44336;
            font-weight: bold;
        }
        
        .round-badge {
            display: inline-block;
            background: #9c27b0;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .leader-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .leader-badge.tied {
            background: #ff9800;
        }
        
        .replay-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .replay-btn {
            background: #ffd700;
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .replay-btn:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }
        
        .replay-btn.active {
            background: #4CAF50;
            color: white;
        }
        
        .replay-btn.slow-mo {
            background: #2196F3;
            color: white;
        }
        
        .mistake-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            z-index: 5;
            display: none;
            border: 4px solid white;
            box-shadow: 0 0 30px rgba(244, 67, 54, 0.8);
            animation: pulse 1s infinite;
        }
        
        .mistake-marker.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }
        
        .replay-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 10;
            display: none;
        }
        
        .replay-info.active {
            display: block;
        }
        
        .clips-list {
            padding: 20px;
            background: #f9f9f9;
        }
        
        .clips-list h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .clip-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .clip-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .clip-item.player1 {
            border-left-color: #4CAF50;
        }
        
        .clip-item.player2 {
            border-left-color: #f44336;
        }
        
        .clip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .clip-time {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .clip-type {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
        }
        
        .clip-description {
            color: #666;
            margin-top: 5px;
        }
        
        .player-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-right: 10px;
        }
        
        .player-badge.player2 {
            background: #f44336;
        }
        
        .no-clips {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .player-info {
                flex-direction: column;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .filter-btn {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .player-selector {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-size: 0.9em;
        }
        
        .player-selector select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 3px;
            margin-left: 10px;
        }
        
        .player-status {
            position: absolute;
            top: 60px;
            left: 20px;
            z-index: 10;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.85em;
            display: none;
        }
        
        .player-status.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        .player-status.active {
            display: block;
        }
        
        #videoPlayerPlyr {
            width: 100%;
            display: none;
        }
        
        #videoPlayerVideoJS {
            width: 100%;
            display: none;
        }
        
        #videoPlayerAlt {
            width: 100%;
            display: none;
        }
    </style>
    
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />
    
    <!-- Plyr CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ 2XKO Gameplay Analysis</h1>
            <p>Review mistakes and improve your gameplay</p>
            
            <div class="player-info">
                <div class="player-card">
                    <img src="character_images/player1_character.png" alt="Player 1">
                    <h3>Player 1</h3>
                    <div class="position-badge">Starting: LEFT</div>
                    <div>
                        <span class="color-indicator" style="background: rgb(72, 63, 64)"></span>
                    </div>
                </div>
                
                <div class="player-card">
                    <img src="character_images/player2_character.png" alt="Player 2">
                    <h3>Player 2</h3>
                    <div class="position-badge">Starting: RIGHT</div>
                    <div>
                        <span class="color-indicator" style="background: rgb(79, 87, 127)"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-section">
            <h2 style="text-align: center; color: #333; margin-bottom: 10px;">Match Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Player 1 - Move Variety</h4>
                    <p><strong>Total Moves:</strong> 71</p>
                    <p><strong>Unique Moves:</strong> 9</p>
                    <div class="move-list">
                        
                <div class="move-item">
                    <span class="move-name">Crouching Heavy Kick</span>
                    <span style="color: #999; font-size: 0.85em;">(2H)</span>
                    
                    <span class="move-count">12x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Light Punch</span>
                    <span style="color: #999; font-size: 0.85em;">(5L)</span>
                    
                    <span class="move-count">10x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Rocket Grab</span>
                    <span style="color: #999; font-size: 0.85em;">(5S1)</span>
                    
                    <span class="move-count">9x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Crouching Light Kick</span>
                    <span style="color: #999; font-size: 0.85em;">(2L)</span>
                    
                    <span class="move-count">8x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Medium Punch</span>
                    <span style="color: #999; font-size: 0.85em;">(5M)</span>
                    
                    <span class="move-count">8x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Crouching Medium Kick</span>
                    <span style="color: #999; font-size: 0.85em;">(2M)</span>
                    
                    <span class="move-count">6x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Garbage Collection (Command Grab)</span>
                    <span style="color: #999; font-size: 0.85em;">(2S2)</span>
                    
                    <span class="move-count">6x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Heavy Punch</span>
                    <span style="color: #999; font-size: 0.85em;">(5H)</span>
                    
                    <span class="move-count">6x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Air Purifier (Down Special)</span>
                    <span style="color: #999; font-size: 0.85em;">(2S1)</span>
                    
                    <span class="move-count">6x</span>
                </div>
            
                    </div>
                </div>
                
                <div class="stat-card">
                    <h4>Player 2 - Move Variety</h4>
                    <p><strong>Total Moves:</strong> 84</p>
                    <p><strong>Unique Moves:</strong> 9</p>
                    <div class="move-list">
                        
                <div class="move-item">
                    <span class="move-name">Crouching Medium Kick</span>
                    <span style="color: #999; font-size: 0.85em;">(2M)</span>
                    
                    <span class="move-count">17x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Garbage Collection (Command Grab)</span>
                    <span style="color: #999; font-size: 0.85em;">(2S2)</span>
                    
                    <span class="move-count">13x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Air Purifier (Down Special)</span>
                    <span style="color: #999; font-size: 0.85em;">(2S1)</span>
                    
                    <span class="move-count">13x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Crouching Heavy Kick</span>
                    <span style="color: #999; font-size: 0.85em;">(2H)</span>
                    
                    <span class="move-count">9x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Light Punch</span>
                    <span style="color: #999; font-size: 0.85em;">(5L)</span>
                    
                    <span class="move-count">9x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Rocket Grab</span>
                    <span style="color: #999; font-size: 0.85em;">(5S1)</span>
                    
                    <span class="move-count">7x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Heavy Punch</span>
                    <span style="color: #999; font-size: 0.85em;">(5H)</span>
                    
                    <span class="move-count">6x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Crouching Light Kick</span>
                    <span style="color: #999; font-size: 0.85em;">(2L)</span>
                    
                    <span class="move-count">5x</span>
                </div>
            
                <div class="move-item">
                    <span class="move-name">Medium Punch</span>
                    <span style="color: #999; font-size: 0.85em;">(5M)</span>
                    
                    <span class="move-count">5x</span>
                </div>
            
                    </div>
                </div>
                
                
                <div class="stat-card">
                    <h4>Overall Damage Summary</h4>
                    <div style="margin-bottom: 15px;">
                        <div style="text-align: center; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 5px; margin-bottom: 10px;">
                            <strong style="color: #4CAF50;">Current Leader: Player 1</strong>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Player 1:</strong>
                        <div style="margin-left: 15px; margin-top: 5px;">
                            <div>Dealt: <span style="color: #4CAF50;">456</span></div>
                            <div>Taken: <span style="color: #f44336;">418</span></div>
                            <div>Net: <span style="color: #4CAF50; font-weight: bold;">+38</span></div>
                        </div>
                    </div>
                    <div>
                        <strong>Player 2:</strong>
                        <div style="margin-left: 15px; margin-top: 5px;">
                            <div>Dealt: <span style="color: #4CAF50;">418</span></div>
                            <div>Taken: <span style="color: #f44336;">456</span></div>
                            <div>Net: <span style="color: #f44336; font-weight: bold;">-38</span></div>
                        </div>
                    </div>
                </div>
        
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterClips('all', this)">All Mistakes</button>
                <button class="filter-btn" onclick="filterClips('player1', this)">Player 1 Mistakes</button>
                <button class="filter-btn" onclick="filterClips('player2', this)">Player 2 Mistakes</button>
            </div>
        </div>
        
        <div class="video-section">
            <div class="video-container">
                <div class="player-selector">
                    <label>Player Method:</label>
                    <select id="playerMethod" onchange="switchPlayerMethod()">
                        <option value="native">Method 1: Native HTML5</option>
                        <option value="plyr">Method 2: Plyr Player</option>
                        <option value="videojs">Method 3: Video.js</option>
                        <option value="alt">Method 4: Alternative HTML5</option>
                    </select>
                    <a href="video_player_backup.html" target="_blank" style="margin-left: 15px; color: #00ff00; text-decoration: none; font-weight: bold; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 3px; border: 1px solid #00ff00;">‚ö° BACKUP PLAYER</a>
                    <a href="test_player.html" target="_blank" style="margin-left: 10px; color: #ffff00; text-decoration: none; font-weight: bold; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 3px; border: 1px solid #ffff00;">üîç QA TESTS</a>
                </div>
                <div class="player-status" id="playerStatus"></div>
                
                <!-- Method 1: Native HTML5 -->
                <video id="videoPlayer" controls style="display: block;" preload="metadata" playsinline>
                    <source id="videoSource" src="" type="video/mp4">
                    <source id="videoSourceWebm" src="" type="video/webm">
                    Your browser does not support the video tag.
                </video>
                
                <!-- Method 2: Plyr Player -->
                <video id="videoPlayerPlyr" controls style="display: none;" preload="metadata">
                    <source id="videoSourcePlyr" src="" type="video/mp4">
                </video>
                
                <!-- Method 3: Video.js -->
                <video id="videoPlayerVideoJS" class="video-js vjs-default-skin" controls preload="auto" data-setup="{}" style="display: none;">
                    <source id="videoSourceVideoJS" src="" type="video/mp4">
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a web browser that
                        <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                    </p>
                </video>
                
                <!-- Method 4: Alternative HTML5 with multiple sources -->
                <video id="videoPlayerAlt" controls style="display: none;" preload="metadata">
                    <source id="videoSourceAlt1" src="" type="video/mp4">
                    <source id="videoSourceAlt2" src="" type="video/webm">
                    <source id="videoSourceAlt3" src="" type="video/ogg">
                    Your browser does not support the video tag.
                </video>
                
                <div class="replay-controls">
                    <button class="replay-btn" id="replayBtn" onclick="toggleReplay()" title="Toggle Instant Replay">
                        üîÑ Instant Replay
                    </button>
                    <button class="replay-btn slow-mo" id="slowMoBtn" onclick="toggleSlowMotion()" title="Toggle Slow Motion">
                        ‚è±Ô∏è Slow Motion
                    </button>
                </div>
                <div class="mistake-marker" id="mistakeMarker">
                    ‚ö†Ô∏è MISTAKE MOMENT ‚ö†Ô∏è
                </div>
                <div class="replay-info" id="replayInfo">
                    Replay: <span id="replayCount">0</span> times
                </div>
                <div class="annotation-overlay" id="annotationOverlay">
                    <div class="annotation-title" id="annotationTitle"></div>
                    <div class="annotation-text" id="annotationText"></div>
                </div>
            </div>
        </div>
        
        <div class="clips-list">
            <h2>Mistake Clips</h2>
            <div id="clipsContainer">
                
                <div class="clip-item unknown" onclick="playClip(0, currentFilter)">
                    <div class="clip-header">
                        <div>
                            <span class="player-badge unknown">Player 1</span>
                            <span class="clip-time" title="Match time when clip starts">01:17</span>
                            <span style="font-size: 0.85em; color: #999; margin-left: 5px;" title="Mistake occurs ~1s into clip">(mistake at ~01:18)</span>
                            <span class="round-badge">Round 1</span>
                            <span class="leader-badge ">Player 1 Leading</span>
                            <button class="replay-btn" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px;" onclick="event.stopPropagation(); playClip(0, currentFilter); setTimeout(() => toggleReplay(), 500);" title="Play with Instant Replay">
                                üîÑ Replay
                            </button>
                        </div>
                        <span class="clip-type">unsafe_special</span>
                    </div>
                    <div class="clip-description"><strong>player1 used Rocket Grab (5S1) which can be easily punished on whiff</strong></div>
                    
                    
                    <div class="damage-info">
                        <div class="damage-row">
                            <span class="damage-label">Damage Dealt:</span>
                            <span class="damage-value">274</span>
                        </div>
                        <div class="damage-row">
                            <span class="damage-label">Damage Taken:</span>
                            <span class="damage-value">185</span>
                        </div>
                        <div class="damage-row">
                            <span class="damage-label">Net Damage:</span>
                            <span class="damage-value">89</span>
                        </div>
                    </div>
                
                    <div class="clip-description" style="margin-top: 5px; font-style: italic;">üí° Rocket Grab is risky in neutral. Consider using it after conditioning opponent or with assist cover. Consider using at mid-range (not point-blank)</div>
                    <div class="clip-description" style="margin-top: 5px; color: #f44336;">üìè Range: Consider using at mid-range (not point-blank)</div>
                </div>
            
                <div class="clip-item unknown" onclick="playClip(1, currentFilter)">
                    <div class="clip-header">
                        <div>
                            <span class="player-badge unknown">Player 2</span>
                            <span class="clip-time">00:38</span>
                            <span class="round-badge">Round 1</span>
                            <span class="leader-badge ">Player 1 Leading</span>
                            <button class="replay-btn" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px;" onclick="event.stopPropagation(); playClip(1, currentFilter); setTimeout(() => toggleReplay(), 500);" title="Play with Instant Replay">
                                üîÑ Replay
                            </button>
                        </div>
                        <span class="clip-type">unsafe_special</span>
                    </div>
                    <div class="clip-description"><strong>player2 used Rocket Grab (5S1) which can be easily punished on whiff</strong></div>
                    
                    
                    <div class="damage-info">
                        <div class="damage-row">
                            <span class="damage-label">Damage Dealt:</span>
                            <span class="damage-value">135</span>
                        </div>
                        <div class="damage-row">
                            <span class="damage-label">Damage Taken:</span>
                            <span class="damage-value">226</span>
                        </div>
                        <div class="damage-row">
                            <span class="damage-label">Net Damage:</span>
                            <span class="damage-value">-91</span>
                        </div>
                    </div>
                
                    <div class="clip-description" style="margin-top: 5px; font-style: italic;">üí° Rocket Grab is risky in neutral. Consider using it after conditioning opponent or with assist cover. Consider using at mid-range (not point-blank)</div>
                    <div class="clip-description" style="margin-top: 5px; color: #f44336;">üìè Range: Consider using at mid-range (not point-blank)</div>
                </div>
            
            </div>
        </div>
    </div>
    
    <!-- Video.js JS -->
    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    
    <!-- Plyr JS -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    
    <script>
        const clips = [{"id": "mistake_unknown_0", "path": "clips\\mistake_unknown_0.mp4", "start_time": 77.46666666666667, "end_time": 83.46666666666667, "player": "unknown", "mistake_type": "unsafe_special", "description": "player1 used Rocket Grab (5S1) which can be easily punished on whiff", "suggestion": "Rocket Grab is risky in neutral. Consider using it after conditioning opponent or with assist cover. Consider using at mid-range (not point-blank)", "damage_dealt": 274, "damage_taken": 185, "player_name": "Player 1", "range_suggestion": "Consider using at mid-range (not point-blank)", "round": 1, "leader": "player1"}, {"id": "mistake_unknown_1", "path": "clips\\mistake_unknown_1.mp4", "start_time": 38.2, "end_time": 44.2, "player": "unknown", "mistake_type": "unsafe_special", "description": "player2 used Rocket Grab (5S1) which can be easily punished on whiff", "suggestion": "Rocket Grab is risky in neutral. Consider using it after conditioning opponent or with assist cover. Consider using at mid-range (not point-blank)", "damage_dealt": 135, "damage_taken": 226, "player_name": "Player 2", "range_suggestion": "Consider using at mid-range (not point-blank)", "round": 1, "leader": "player1"}];
        let currentFilter = 'all';
        // Make currentFilter globally accessible for onclick handlers
        window.currentFilter = currentFilter;
        let currentClipIndex = -1;
        let isReplayMode = false;
        let isSlowMotion = false;
        let replayCount = 0;
        let mistakeTimestamp = 0; // Timestamp of the mistake moment in the clip
        let replayInterval = null;
        let currentPlayerMethod = 'native';
        let currentPlayer = null;
        let plyrInstance = null;
        let videojsInstance = null;
        let failedMethods = new Set(); // Track which methods have failed to prevent infinite loops
        let fallbackInProgress = false; // Prevent multiple simultaneous fallbacks
        
        // Initialize players
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Try to initialize Plyr
                try {
                    if (typeof Plyr !== 'undefined') {
                        const plyrVideo = document.getElementById('videoPlayerPlyr');
                        if (plyrVideo) {
                            plyrInstance = new Plyr(plyrVideo, {
                                controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
                                settings: ['speed']
                            });
                        }
                    }
                } catch (e) {
                    console.log('Plyr initialization failed:', e);
                }
                
                // Try to initialize Video.js (only if not already initialized)
                try {
                    if (typeof videojs !== 'undefined') {
                        const videojsElement = document.getElementById('videoPlayerVideoJS');
                        if (videojsElement) {
                            // Check if already initialized
                            if (videojs.getPlayer && !videojs.getPlayer(videojsElement)) {
                                videojsInstance = videojs(videojsElement, {
                                    controls: true,
                                    fluid: true,
                                    responsive: true
                                });
                            } else if (videojs.getPlayer) {
                                videojsInstance = videojs.getPlayer(videojsElement);
                            }
                        }
                    }
                } catch (e) {
                    console.log('Video.js initialization failed:', e);
                }
                
                // Set default player to native (most compatible)
                switchPlayerMethod('native');
                
                // Test if native HTML5 can play the video format (only if clips exist)
                if (clips && clips.length > 0) {
                    const testVideo = document.createElement('video');
                    const firstClipPath = clips[0].path.replace(/\\/g, '/');
                    if (!firstClipPath.startsWith('clips/')) {
                        testVideo.src = 'clips/' + firstClipPath.split('/').pop();
                    } else {
                        testVideo.src = firstClipPath;
                    }
                    testVideo.addEventListener('loadedmetadata', () => {
                        console.log('‚úì Native HTML5 can load video metadata');
                    });
                    testVideo.addEventListener('error', (e) => {
                        console.warn('‚ö† Native HTML5 video test failed:', testVideo.error);
                        if (testVideo.error) {
                            console.warn('Error code:', testVideo.error.code);
                            console.warn('This may indicate a codec compatibility issue');
                        }
                    });
                }
            } catch (e) {
                console.error('Error during initialization:', e);
            }
        });
        
        // Make functions globally accessible
        window.switchPlayerMethod = function(method = null) {
            const selector = document.getElementById('playerMethod');
            if (!selector) return;
            
            const methodToUse = method || selector.value;
            const statusDiv = document.getElementById('playerStatus');
            
            // Hide all players (check if they exist first)
            const players = [
                document.getElementById('videoPlayer'),
                document.getElementById('videoPlayerPlyr'),
                document.getElementById('videoPlayerVideoJS'),
                document.getElementById('videoPlayerAlt')
            ];
            
            players.forEach(player => {
                if (player) {
                    player.style.display = 'none';
                }
            });
            
            // Stop current player (handle different player types)
            if (currentPlayer) {
                try {
                    if (currentPlayerMethod === 'plyr' && plyrInstance) {
                        plyrInstance.pause();
                    } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                        videojsInstance.pause();
                    } else if (currentPlayer.pause && typeof currentPlayer.pause === 'function') {
                        currentPlayer.pause();
                    }
                } catch (e) {
                    console.log('Error pausing player:', e);
                }
            }
            
            currentPlayerMethod = methodToUse;
            selector.value = methodToUse;
            
            // Show selected player
            let playerElement = null;
            let playerName = '';
            
            switch (methodToUse) {
                case 'native':
                    playerElement = document.getElementById('videoPlayer');
                    playerName = 'Native HTML5';
                    break;
                case 'plyr':
                    playerElement = document.getElementById('videoPlayerPlyr');
                    playerName = 'Plyr Player';
                    break;
                case 'videojs':
                    playerElement = document.getElementById('videoPlayerVideoJS');
                    playerName = 'Video.js';
                    break;
                case 'alt':
                    playerElement = document.getElementById('videoPlayerAlt');
                    playerName = 'Alternative HTML5';
                    break;
            }
            
            if (playerElement) {
                playerElement.style.display = 'block';
                currentPlayer = playerElement;
                
                // Update status
                statusDiv.textContent = `Using: ${playerName}`;
                statusDiv.className = 'player-status active';
                
                // Try to load current clip if one is selected
                if (currentClipIndex >= 0) {
                    loadVideoInCurrentPlayer();
                }
                
                // Re-setup replay listeners if replay mode is active
                if (isReplayMode) {
                    setupReplayListeners();
                }
            }
        }
        
        // Test if a video file is accessible
        async function testVideoAccessibility(videoPath) {
            try {
                if (!videoPath) {
                    console.error('testVideoAccessibility: videoPath is empty');
                    return false;
                }
                
                let fullUrl;
                try {
                    fullUrl = new URL(videoPath, window.location.href).href;
                } catch (e) {
                    console.error('Error constructing URL:', e);
                    return false;
                }
                
                console.log(`Testing video accessibility: ${fullUrl}`);
                
                const response = await fetch(fullUrl, { method: 'HEAD' });
                if (response.ok) {
                    const contentType = response.headers.get('Content-Type') || 'unknown';
                    console.log(`Video file is accessible: ${fullUrl} (Content-Type: ${contentType})`);
                    return true;
                } else {
                    console.error(`Video file returned status ${response.status}: ${fullUrl}`);
                    return false;
                }
            } catch (error) {
                console.error(`Error testing video accessibility: ${error.message}`);
                try {
                    console.error(`Tried to access: ${new URL(videoPath, window.location.href).href}`);
                } catch (e) {
                    console.error(`Could not construct URL for: ${videoPath}`);
                }
                return false;
            }
        }
        
        function loadVideoInCurrentPlayer() {
            const filteredClips = currentFilter === 'all' 
                ? clips 
                : clips.filter(c => c.player === currentFilter);
            
            if (currentClipIndex < 0 || currentClipIndex >= filteredClips.length) {
                console.warn('Invalid clip index:', currentClipIndex);
                return;
            }
            
            const clip = filteredClips[currentClipIndex];
            // Normalize path - handle both forward and backslashes
            let videoPath = clip.path || '';
            
            if (!videoPath) {
                console.error('No video path in clip:', clip);
                return;
            }
            
            // Convert backslashes to forward slashes
            videoPath = videoPath.replace(/\\/g, '/');
            
            // If it's a relative path, ensure it starts with clips/
            if (!videoPath.startsWith('http') && !videoPath.startsWith('/') && !videoPath.startsWith('./')) {
                // Remove any existing clips/ prefix to avoid duplication
                if (videoPath.startsWith('clips/')) {
                    videoPath = videoPath;
                } else {
                    videoPath = 'clips/' + videoPath.split('/').pop();
                }
            }
            
            const fullUrl = new URL(videoPath, window.location.href).href;
            console.log(`Loading video: ${videoPath} (method: ${currentPlayerMethod})`);
            console.log(`Full URL: ${fullUrl}`);
            console.log(`Current page URL: ${window.location.href}`);
            console.log(`Base URL: ${window.location.origin}`);
            
            // Test if video file is accessible BEFORE attempting to load
            testVideoAccessibility(videoPath).then(accessible => {
                if (!accessible) {
                    const statusDiv = document.getElementById('playerStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                                <div>
                                    <strong>Video Clip Not Available</strong><br>
                                    <small>The video file "${videoPath}" could not be found.</small><br>
                                    <small style="color: #888;">This clip may not have been generated yet, or the file may have been moved.</small>
                                </div>
                            </div>
                        `;
                        statusDiv.className = 'player-status active error';
                    }
                    
                    // Show clip information even when video is missing
                    showClipInfoWhenUnavailable(clip);
                    
                    // Hide video players
                    const players = ['videoPlayer', 'videoPlayerPlyr', 'videoPlayerVideoJS', 'videoPlayerAlt'];
                    for (let i = 0; i < players.length; i++) {
                        const player = document.getElementById(players[i]);
                        if (player) {
                            player.style.display = 'none';
                        }
                    }
                    
                    // Don't attempt to load the video
                    console.warn(`Video file not accessible: ${videoPath} - Skipping load attempt`);
                    return; // Exit early, don't load video
                } else {
                    console.log(`‚úì Video file is accessible at: ${fullUrl}`);
                    
                    // Hide unavailable info if it exists
                    const infoDiv = document.getElementById('clipInfoUnavailable');
                    if (infoDiv) {
                        infoDiv.style.display = 'none';
                    }
                    
                    // Continue with normal loading
                    loadVideoContent();
                }
            }).catch(error => {
                console.error('Error checking video accessibility:', error);
                const statusDiv = document.getElementById('playerStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">‚ùå</span>
                            <div>
                                <strong>Error Checking Video</strong><br>
                                <small>Unable to verify if video file exists.</small>
                            </div>
                        </div>
                    `;
                    statusDiv.className = 'player-status active error';
                }
                // On error, still try to load (might be CORS issue, not missing file)
                loadVideoContent();
            });
            
            // Function to actually load the video content (only called if file is accessible)
            function loadVideoContent() {
                let sourceElement = null;
                let playerElement = null;
                
                switch (currentPlayerMethod) {
                case 'native':
                    playerElement = document.getElementById('videoPlayer');
                    sourceElement = document.getElementById('videoSource');
                    if (sourceElement) {
                        sourceElement.src = videoPath;
                        // Also set the video element src directly as fallback
                        if (playerElement) {
                            playerElement.src = videoPath;
                        }
                    }
                    break;
                case 'plyr':
                    playerElement = document.getElementById('videoPlayerPlyr');
                    sourceElement = document.getElementById('videoSourcePlyr');
                    if (sourceElement) sourceElement.src = videoPath;
                    if (plyrInstance) {
                        try {
                            const plyrSource = {
                                type: 'video',
                                sources: [{
                                    src: videoPath,
                                    type: 'video/mp4'
                                }]
                            };
                            plyrInstance.source = plyrSource;
                        } catch (e) {
                            console.error('Plyr source error:', e);
                        }
                    }
                    break;
                case 'videojs':
                    playerElement = document.getElementById('videoPlayerVideoJS');
                    sourceElement = document.getElementById('videoSourceVideoJS');
                    if (sourceElement) sourceElement.src = videoPath;
                    if (videojsInstance) {
                        try {
                            videojsInstance.src({ type: 'video/mp4', src: videoPath });
                            videojsInstance.load();
                        } catch (e) {
                            console.error('Video.js source error:', e);
                        }
                    }
                    break;
                case 'alt':
                    playerElement = document.getElementById('videoPlayerAlt');
                    sourceElement = document.getElementById('videoSourceAlt1');
                    if (sourceElement) sourceElement.src = videoPath;
                    break;
            }
            
            if (!playerElement) {
                console.error(`Player element not found for method: ${currentPlayerMethod}`);
                // Try to find the element again
                switch(currentPlayerMethod) {
                    case 'native':
                        playerElement = document.getElementById('videoPlayer');
                        break;
                    case 'plyr':
                        playerElement = document.getElementById('videoPlayerPlyr');
                        break;
                    case 'videojs':
                        playerElement = document.getElementById('videoPlayerVideoJS');
                        break;
                    case 'alt':
                        playerElement = document.getElementById('videoPlayerAlt');
                        break;
                }
                
                if (!playerElement) {
                    console.error(`Player element still not found after retry for method: ${currentPlayerMethod}`);
                    // Don't trigger fallback for missing DOM elements - this is a code issue, not a video issue
                    const statusDiv = document.getElementById('playerStatus');
                    if (statusDiv) {
                        statusDiv.textContent = `Error: Player element missing for ${currentPlayerMethod}`;
                        statusDiv.className = 'player-status active error';
                    }
                    return;
                }
            }
            
            // Stop any current playback first
            try {
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    plyrInstance.stop();
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    videojsInstance.pause();
                } else if (playerElement.pause && typeof playerElement.pause === 'function') {
                    playerElement.pause();
                }
            } catch (e) {
                console.log('Error stopping player:', e);
            }
            
            // Load video - use appropriate method for each player type
            // Note: Video.js load() is already called in the switch case above
            try {
                if (currentPlayerMethod !== 'videojs') {
                    // Native HTML5, Plyr, and Alt use the standard load() method
                    if (playerElement.load && typeof playerElement.load === 'function') {
                        playerElement.load();
                    } else {
                        console.warn(`load() method not available for ${currentPlayerMethod} player`);
                    }
                }
                // Video.js load() is already handled in the switch case
            } catch (e) {
                console.error('Error loading video:', e);
            }
            
            currentPlayer = playerElement;
            
            // Set up error handling with fallback (different for each player type)
                if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    // Video.js error handling
                    videojsInstance.on('error', function() {
                        const error = videojsInstance.error();
                        if (error) {
                            console.error(`Video.js error (code: ${error.code}):`, error.message);
                            const MEDIA_ERR_SRC_NOT_SUPPORTED_CODE_3 = 4; // MEDIA_ERR_SRC_NOT_SUPPORTED
                            if (error.code === MEDIA_ERR_SRC_NOT_SUPPORTED_CODE_3) {
                                const fullUrl = new URL(videoPath, window.location.href).href;
                                console.error(`Video.js: Source not supported - ${videoPath}`);
                                console.error(`Full URL: ${fullUrl}`);
                                console.error(`Error details:`, error);
                                console.error(`Try opening this URL directly in your browser: ${fullUrl}`);
                                
                                // Test if file is accessible
                                testVideoAccessibility(videoPath).then(accessible => {
                                    if (!accessible) {
                                        const statusDiv = document.getElementById('playerStatus');
                                        if (statusDiv) {
                                            statusDiv.textContent = `Error: Video file not found at ${videoPath}. Check if file exists and server is running from the output directory.`;
                                            statusDiv.className = 'player-status active error';
                                        }
                                    } else {
                                        console.warn('File is accessible but Video.js cannot play it. May be a codec/format issue.');
                                    }
                                });
                                
                                // Only try fallback if we haven't tried all methods
                                if (failedMethods.size < 4) {
                                    setTimeout(() => {
                                        tryNextPlayerMethod();
                                    }, 1000);
                                } else {
                                    const statusDiv = document.getElementById('playerStatus');
                                    if (statusDiv) {
                                        statusDiv.textContent = `Error: Video file not found or not supported: ${videoPath}. Check console for details.`;
                                        statusDiv.className = 'player-status active error';
                                    }
                                }
                            }
                        }
                    });
                    
                    videojsInstance.ready(function() {
                        console.log(`Video.js ready with method: ${currentPlayerMethod}`);
                        const statusDiv = document.getElementById('playerStatus');
                        if (statusDiv) {
                            statusDiv.textContent = `Loaded: ${currentPlayerMethod}`;
                            statusDiv.className = 'player-status active';
                        }
                        if (isReplayMode) {
                            setupReplayListeners();
                        }
                    });
                } else if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    // Plyr error handling
                    plyrInstance.on('error', function(e) {
                        console.error('Plyr error:', e);
                        const statusDiv = document.getElementById('playerStatus');
                        if (statusDiv) {
                            statusDiv.textContent = `Error loading video: ${videoPath}`;
                            statusDiv.className = 'player-status active error';
                        }
                        // Only try fallback if we haven't tried all methods
                        if (failedMethods.size < 4) {
                            setTimeout(() => {
                                tryNextPlayerMethod();
                            }, 1000);
                        } else {
                            const statusDiv = document.getElementById('playerStatus');
                            if (statusDiv) {
                                statusDiv.textContent = `Error loading video: ${videoPath}`;
                                statusDiv.className = 'player-status active error';
                            }
                        }
                    });
                    
                    plyrInstance.on('ready', function() {
                        console.log(`Plyr ready with method: ${currentPlayerMethod}`);
                        const statusDiv = document.getElementById('playerStatus');
                        if (statusDiv) {
                            statusDiv.textContent = `Loaded: ${currentPlayerMethod}`;
                            statusDiv.className = 'player-status active';
                        }
                        if (isReplayMode) {
                            setupReplayListeners();
                        }
                    });
                } else if (playerElement) {
                    // Native HTML5 error handling
                    const errorHandler = function(e) {
                        console.error(`Player method ${currentPlayerMethod} failed:`, e);
                        const error = playerElement.error;
                        if (error) {
                            let errorMsg = '';
                            // Use numeric codes for compatibility (MediaError might not be defined)
                            const MEDIA_ERR_ABORTED = 1;
                            const MEDIA_ERR_NETWORK = 2;
                            const MEDIA_ERR_DECODE = 3;
                            const MEDIA_ERR_SRC_NOT_SUPPORTED = 4;
                            
                            switch(error.code) {
                                case MEDIA_ERR_ABORTED:
                                case (typeof MediaError !== 'undefined' ? MediaError.MEDIA_ERR_ABORTED : 1):
                                    errorMsg = 'Video loading aborted';
                                    break;
                                case MEDIA_ERR_NETWORK:
                                case (typeof MediaError !== 'undefined' ? MediaError.MEDIA_ERR_NETWORK : 2):
                                    errorMsg = 'Network error while loading video';
                                    break;
                                case MEDIA_ERR_DECODE:
                                case (typeof MediaError !== 'undefined' ? MediaError.MEDIA_ERR_DECODE : 3):
                                    errorMsg = 'Video decoding error';
                                    break;
                                case MEDIA_ERR_SRC_NOT_SUPPORTED:
                                case (typeof MediaError !== 'undefined' ? MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED : 4):
                                    errorMsg = `Video source not supported: ${videoPath}`;
                                    break;
                                default:
                                    errorMsg = `Unknown error (code: ${error.code})`;
                            }
                            console.error(errorMsg);
                            
                            const MEDIA_ERR_SRC_NOT_SUPPORTED_CODE = typeof MediaError !== 'undefined' ? MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED : 4;
                            if (error.code === MEDIA_ERR_SRC_NOT_SUPPORTED_CODE || error.code === 4) {
                                const fullUrl = new URL(videoPath, window.location.href).href;
                                console.error(`Native player: Source not supported - ${videoPath}`);
                                console.error(`Full URL: ${fullUrl}`);
                                console.error(`‚ö† This usually means the video codec is not supported by your browser.`);
                                console.error(`The file exists and is accessible, but the video codec inside the MP4 container may not be supported.`);
                                console.error(`Try opening this URL directly in your browser: ${fullUrl}`);
                                console.error(`If it plays directly, the issue is with the player. If it doesn't, the codec isn't supported.`);
                                
                                // Test if file is accessible
                                testVideoAccessibility(videoPath).then(accessible => {
                                    if (!accessible) {
                                        const statusDiv = document.getElementById('playerStatus');
                                        if (statusDiv) {
                                            statusDiv.textContent = `Error: Video file not found at ${videoPath}. Make sure the file exists and the server is running from the correct directory.`;
                                            statusDiv.className = 'player-status active error';
                                        }
                                    } else {
                                        // File is accessible but can't be played - codec issue
                                        const statusDiv = document.getElementById('playerStatus');
                                        if (statusDiv) {
                                            statusDiv.textContent = `Error: Video codec not supported. File exists but browser cannot decode it. Try opening ${fullUrl} directly.`;
                                            statusDiv.className = 'player-status active error';
                                        }
                                    }
                                });
                                
                                // Only try fallback if we haven't tried all methods
                                if (failedMethods.size < 4) {
                                    setTimeout(() => {
                                        tryNextPlayerMethod();
                                    }, 1000);
                                } else {
                                    const statusDiv = document.getElementById('playerStatus');
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `Error: Video codec not supported by any player. <br>File exists at: ${fullUrl}<br>Try opening it directly in your browser. If it doesn't play, the video needs to be re-encoded with a supported codec (H.264/AAC).`;
                                        statusDiv.className = 'player-status active error';
                                    }
                                }
                            }
                        }
                    };
                    
                    playerElement.addEventListener('error', errorHandler, { once: true });
                    
                    // Set up replay listeners after video is loaded
                    playerElement.addEventListener('loadeddata', function() {
                        if (isReplayMode) {
                            setupReplayListeners();
                        }
                    }, { once: true });
                    
                    // Log when video is ready
                    playerElement.addEventListener('canplay', function() {
                        console.log(`‚úì Video loaded successfully with method: ${currentPlayerMethod}`);
                        const statusDiv = document.getElementById('playerStatus');
                        if (statusDiv) {
                            statusDiv.textContent = `Loaded: ${currentPlayerMethod}`;
                            statusDiv.className = 'player-status active';
                        }
                    }, { once: true });
                    
                    // Log when video can start playing
                    playerElement.addEventListener('loadedmetadata', function() {
                        console.log(`‚úì Video metadata loaded. Duration: ${playerElement.duration}s, ReadyState: ${playerElement.readyState}`);
                        console.log(`Video codec info:`, {
                            videoCodecs: playerElement.canPlayType('video/mp4; codecs="avc1.42E01E"') ? 'H.264 supported' : 'H.264 not supported',
                            videoCodecs2: playerElement.canPlayType('video/mp4; codecs="avc1.640028"') ? 'H.264 High Profile supported' : 'H.264 High Profile not supported',
                            videoCodecs3: playerElement.canPlayType('video/mp4; codecs="hev1.1.6.L93.B0"') ? 'HEVC supported' : 'HEVC not supported'
                        });
                    }, { once: true });
                    
                    // Log any loading issues
                    playerElement.addEventListener('stalled', function() {
                        console.warn('Video loading stalled');
                    });
                    
                    playerElement.addEventListener('waiting', function() {
                        console.warn('Video waiting for data');
                    });
                    
                    // Better error handling for native player
                    playerElement.addEventListener('error', function(e) {
                        const error = playerElement.error;
                        if (error) {
                            console.error(`Native player error (code: ${error.code}):`, {
                                code: error.code,
                                message: error.message || 'Unknown error',
                                MEDIA_ERR_ABORTED: error.code === 1 || (typeof MediaError !== 'undefined' && error.code === MediaError.MEDIA_ERR_ABORTED),
                                MEDIA_ERR_NETWORK: error.code === 2 || (typeof MediaError !== 'undefined' && error.code === MediaError.MEDIA_ERR_NETWORK),
                                MEDIA_ERR_DECODE: error.code === 3 || (typeof MediaError !== 'undefined' && error.code === MediaError.MEDIA_ERR_DECODE),
                                MEDIA_ERR_SRC_NOT_SUPPORTED: error.code === 4 || (typeof MediaError !== 'undefined' && error.code === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED)
                            });
                            
                            const MEDIA_ERR_SRC_NOT_SUPPORTED_CODE = typeof MediaError !== 'undefined' ? MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED : 4;
                            if (error.code === MEDIA_ERR_SRC_NOT_SUPPORTED_CODE || error.code === 4) {
                                console.error('‚ö† This usually means the video codec is not supported by your browser.');
                                console.error('Try opening the video directly: ' + new URL(videoPath, window.location.href).href);
                                console.error('If it plays directly, the issue is with the player, not the video file.');
                            }
                        }
                    }, { once: true });
                    
                    // Handle case where video file doesn't exist
                    playerElement.addEventListener('loadstart', function() {
                        console.log(`Starting to load video: ${videoPath}`);
                    }, { once: true });
            } // End of loadVideoContent function
                }
        }
        
        function tryNextPlayerMethod() {
            if (fallbackInProgress) {
                console.log('Fallback already in progress, skipping...');
                return;
            }
            
            const methods = ['native', 'plyr', 'videojs', 'alt'];
            failedMethods.add(currentPlayerMethod);
            
            // Find next method that hasn't failed yet
            const currentIndex = methods.indexOf(currentPlayerMethod);
            let nextIndex = (currentIndex + 1) % methods.length;
            let attempts = 0;
            
            // Try to find a method that hasn't failed
            while (failedMethods.has(methods[nextIndex]) && attempts < methods.length) {
                nextIndex = (nextIndex + 1) % methods.length;
                attempts++;
            }
            
            if (attempts >= methods.length || failedMethods.size >= methods.length) {
                // All methods have failed
                fallbackInProgress = false;
                failedMethods.clear(); // Reset for next attempt
                const statusDiv = document.getElementById('playerStatus');
                if (statusDiv) {
                    const protocol = window.location.protocol;
                    let errorMsg = 'All playback methods failed. ';
                    if (protocol === 'file:') {
                        errorMsg += 'Note: Opening HTML files directly (file://) may prevent video loading due to browser security. Try using a local web server (e.g., Python: python -m http.server). ';
                    }
                    errorMsg += 'The video file may be missing, corrupted, or in an unsupported format.';
                    statusDiv.textContent = errorMsg;
                    statusDiv.className = 'player-status active error';
                }
                console.error('All playback methods have failed. Video file may be inaccessible.');
                console.error('If using file:// protocol, consider using a local web server instead.');
                return;
            }
            
            if (nextIndex !== currentIndex) {
                fallbackInProgress = true;
                const statusDiv = document.getElementById('playerStatus');
                if (statusDiv) {
                    statusDiv.textContent = `Method ${currentPlayerMethod} failed, trying ${methods[nextIndex]}...`;
                    statusDiv.className = 'player-status active error';
                }
                
                setTimeout(() => {
                    switchPlayerMethod(methods[nextIndex]);
                    if (currentClipIndex >= 0) {
                        loadVideoInCurrentPlayer();
                    }
                    fallbackInProgress = false;
                }, 1000);
            }
        }
        
        function formatTimestamp(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        window.filterClips = function(filter, eventElement = null) {
            try {
                if (!filter) {
                    filter = 'all';
                }
                
                currentFilter = filter;
                window.currentFilter = filter; // Keep in sync for onclick handlers
                
                // Validate clips array
                if (!clips || !Array.isArray(clips)) {
                    console.error('Clips array is not available');
                    const container = document.getElementById('clipsContainer');
                    if (container) {
                        container.innerHTML = '<div class="no-clips">Error: Clips data not loaded</div>';
                    }
                    return;
                }
            
            // Update button states
            const filterButtons = document.querySelectorAll('.filter-btn');
            if (filterButtons.length === 0) {
                console.warn('No filter buttons found');
            }
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                if (eventElement && btn === eventElement) {
                    btn.classList.add('active');
                } else if (!eventElement && btn.textContent.includes(filter === 'all' ? 'All' : (filter === 'player1' ? 'Player 1' : 'Player 2'))) {
                    btn.classList.add('active');
                }
            });
            
            // Filter clips
            const filteredClips = filter === 'all' 
                ? clips 
                : clips.filter(c => c.player === filter);
            
            // Update clips list
            const container = document.getElementById('clipsContainer');
            if (!container) {
                console.error('clipsContainer element not found');
                return;
            }
            
                if (filteredClips.length === 0) {
                    container.innerHTML = '<div class="no-clips">No clips found for this filter.</div>';
                } else {
                    try {
                        container.innerHTML = filteredClips.map((clip, index) => {
                            const timestamp = formatTimestamp(clip.start_time);
                            // Calculate when mistake actually occurs (clip starts 1s before mistake)
                            const mistakeTime = clip.start_time + 1.0;
                            const mistakeTimestamp = formatTimestamp(mistakeTime);
                            const playerName = clip.player === 'player1' ? 'Player 1' : 'Player 2';
                            const playerClass = clip.player;
                            const round = clip.round || 1;
                            const leader = clip.leader || 'tied';
                            const leaderName = leader === 'player1' ? 'Player 1' : (leader === 'player2' ? 'Player 2' : 'Tied');
                            const leaderClass = leader === 'tied' ? 'tied' : '';
                            
                            // Damage info
                            const damageDealt = clip.damage_dealt || 0;
                            const damageTaken = clip.damage_taken || 0;
                            const damageInfo = damageDealt > 0 || damageTaken > 0 ? `
                                <div class="damage-info">
                                    <div class="damage-row">
                                        <span class="damage-label">Damage Dealt:</span>
                                        <span class="damage-value">${damageDealt}</span>
                                    </div>
                                    <div class="damage-row">
                                        <span class="damage-label">Damage Taken:</span>
                                        <span class="damage-value">${damageTaken}</span>
                                    </div>
                                    <div class="damage-row">
                                        <span class="damage-label">Net Damage:</span>
                                        <span class="damage-value">${damageDealt - damageTaken}</span>
                                    </div>
                                </div>
                            ` : '';
                            
                            return `
                                <div class="clip-item ${playerClass}" onclick="playClip(${index}, '${filter}')">
                                    <div class="clip-header">
                                        <div>
                                            <span class="player-badge ${playerClass}">${playerName}</span>
                                            <span class="clip-time" title="Match time when clip starts">${timestamp}</span>
                                            <span style="font-size: 0.85em; color: #999; margin-left: 5px;" title="Mistake occurs ~1s into clip">(mistake at ${mistakeTimestamp})</span>
                                            <span class="round-badge">Round ${round}</span>
                                            <span class="leader-badge ${leaderClass}">${leaderName} Leading</span>
                                            <button class="replay-btn" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px;" onclick="event.stopPropagation(); playClip(${index}, '${filter}'); setTimeout(() => toggleReplay(), 500);" title="Play with Instant Replay">
                                                üîÑ Replay
                                            </button>
                                        </div>
                                        <span class="clip-type">${clip.mistake_type}</span>
                                    </div>
                                    <div class="clip-description"><strong>${clip.description_plain || clip.description}</strong></div>
                                    ${clip.opponent_response_description ? `<div class="clip-description" style="margin-top: 5px; color: #2196F3; font-weight: bold;">‚öîÔ∏è ${clip.opponent_response_description}</div>` : ''}
                                    ${damageInfo}
                                    ${clip.suggestion ? `<div class="clip-description" style="margin-top: 5px; font-style: italic;">üí° ${clip.suggestion}</div>` : ''}
                                    ${clip.range_suggestion ? `<div class="clip-description" style="margin-top: 5px; color: #f44336;">üìè Range: ${clip.range_suggestion}</div>` : ''}
                                </div>
                            `;
                        }).join('');
                    } catch (mapError) {
                        console.error('Error mapping clips:', mapError);
                        container.innerHTML = '<div class="no-clips">Error rendering clips. Check console for details.</div>';
                    }
                }
            } catch (e) {
                console.error('Error in filterClips:', e);
                const container = document.getElementById('clipsContainer');
                if (container) {
                    container.innerHTML = '<div class="no-clips">Error loading clips. Check console for details.</div>';
                }
            }
        }
        
        window.playClip = function(index, filter) {
            try {
                // Validate inputs
                if (typeof index !== 'number' || isNaN(index)) {
                    console.error('Invalid clip index:', index);
                    return;
                }
                
                if (!clips || !Array.isArray(clips)) {
                    console.error('Clips array not available');
                    return;
                }
                
                // Use window.currentFilter if filter is not provided or is undefined
                if (filter === undefined || filter === null) {
                    filter = window.currentFilter || currentFilter || 'all';
                }
                currentFilter = filter;
                window.currentFilter = filter;
                
                const filteredClips = filter === 'all' 
                    ? clips 
                    : clips.filter(c => c && c.player === filter);
                
                if (index < 0 || index >= filteredClips.length) {
                    console.warn(`Invalid clip index: ${index} (available: 0-${filteredClips.length - 1})`);
                    return;
                }
            
            const clip = filteredClips[index];
            const overlay = document.getElementById('annotationOverlay');
            const title = document.getElementById('annotationTitle');
            const text = document.getElementById('annotationText');
            
            currentClipIndex = index;
            currentFilter = filter;
            
            // Reset replay state (but preserve replay mode if it was already on)
            // Don't reset isReplayMode here - let user control it with the button
            const wasReplayMode = isReplayMode;
            const wasSlowMotion = isSlowMotion;
            isSlowMotion = false;
            replayCount = 0;
            isLooping = false;
            
            // Reset failed methods when loading a new clip
            failedMethods.clear();
            fallbackInProgress = false;
            
            // Reset playback rate if slow motion was active
            if (wasSlowMotion && currentPlayer) {
                try {
                    if (currentPlayerMethod === 'plyr' && plyrInstance) {
                        plyrInstance.speed = 1.0;
                    } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                        videojsInstance.playbackRate(1.0);
                    } else if (currentPlayer.playbackRate !== undefined) {
                        currentPlayer.playbackRate = 1.0;
                    }
                } catch (e) {
                    console.log('Error resetting playback rate:', e);
                }
            }
            
            updateReplayButton();
            updateSlowMoButton();
            document.getElementById('replayInfo').classList.remove('active');
            document.getElementById('mistakeMarker').classList.remove('active');
            
            // Load video in current player method
            loadVideoInCurrentPlayer();
            
            // Get the current player element
            let video = currentPlayer;
            if (!video) {
                // Fallback to native player if currentPlayer is not set
                video = document.getElementById('videoPlayer');
                currentPlayer = video;
            }
            
            // Calculate mistake timestamp in the clip
            // Clips are extracted starting 1 second before the mistake
            // So the mistake happens at approximately 1 second into the clip
            // If we have the actual mistake timestamp, calculate it precisely
            if (clip.timestamp !== undefined && clip.start_time !== undefined) {
                // mistakeTimestamp is the time within the clip where the mistake occurs
                mistakeTimestamp = clip.timestamp - clip.start_time;
            } else if (clip.start_time !== undefined && clip.end_time !== undefined) {
                // Estimate: mistake is roughly in the middle of the clip, but closer to start
                // Since clips start 1 second before mistake, mistake is at ~1 second
                mistakeTimestamp = 1.0;
            } else {
                // Default: mistake happens around 1 second into the clip
                mistakeTimestamp = 1.0;
            }
            
            console.log(`Mistake timestamp in clip: ${mistakeTimestamp.toFixed(2)}s (clip start: ${clip.start_time}s, end: ${clip.end_time}s)`);
            
            // Wait for video to be ready, then play
            const tryPlay = () => {
                if (video && video.readyState >= 2) {
                    playVideo().catch(e => {
                        console.log('Autoplay prevented:', e);
                    });
                    setupReplayListeners();
                } else {
                    // Wait for video to load
                    if (video) {
                        video.addEventListener('loadeddata', () => {
                            playVideo().catch(e => {
                                console.log('Autoplay prevented:', e);
                            });
                            setupReplayListeners();
                        }, { once: true });
                    }
                }
            };
            
            tryPlay();
            
            // If replay was already enabled, re-enable it after video loads
            if (wasReplayMode) {
                const enableReplayAfterLoad = () => {
                    if (video && (video.readyState >= 2 || video.readyState === 1)) {
                        isReplayMode = true;
                        setupReplayListeners();
                        updateReplayButton();
                        seekTo(0);
                        setTimeout(() => {
                            playVideo().catch(e => console.log('Replay play error:', e));
                        }, 200);
                    } else {
                        setTimeout(enableReplayAfterLoad, 100);
                    }
                };
                setTimeout(enableReplayAfterLoad, 500);
            }
            
            // Show annotation with comprehensive damage info
            const playerName = clip.player === 'player1' ? 'Player 1' : 'Player 2';
            const round = clip.round || 1;
            const leader = clip.leader || 'tied';
            const leaderName = leader === 'player1' ? 'Player 1' : (leader === 'player2' ? 'Player 2' : 'Tied');
            
            const damageDealt = clip.damage_dealt || 0;
            const damageTaken = clip.damage_taken || 0;
            const netDamage = damageDealt - damageTaken;
            
            title.innerHTML = `${playerName} - ${clip.mistake_type} | Round ${round}`;
            
            let damageText = '';
            if (damageDealt > 0 || damageTaken > 0) {
                damageText = `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(244, 67, 54, 0.2); border-radius: 5px;">
                        <strong>Damage at End of Mistake:</strong><br>
                        ‚Ä¢ ${playerName} Dealt: <span style="color: #4CAF50;">${damageDealt}</span><br>
                        ‚Ä¢ ${playerName} Taken: <span style="color: #f44336;">${damageTaken}</span><br>
                        ‚Ä¢ Net: <span style="color: ${netDamage >= 0 ? '#4CAF50' : '#f44336'};">${netDamage >= 0 ? '+' : ''}${netDamage}</span><br>
                        ‚Ä¢ Leader: <span style="color: #ffd700;">${leaderName}</span>
                    </div>
                `;
            }
            
            const description = clip.contextual_description || clip.description_plain || clip.description;
            const opponentResponse = clip.opponent_response_description || '';
            
            text.innerHTML = `
                <strong>What Happened:</strong> ${description}<br>
                ${opponentResponse ? `<strong style="color: #2196F3;">Opponent's Response:</strong> ${opponentResponse}<br>` : ''}
                ${damageText}
                ${clip.suggestion ? `<strong>Suggestion:</strong> ${clip.suggestion}<br>` : ''}
                ${clip.range_suggestion ? `<strong>Range:</strong> ${clip.range_suggestion}<br>` : ''}
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.2); border-radius: 5px; border-left: 3px solid #ffd700;">
                    <strong>üí° Tip:</strong> Click "Instant Replay" to automatically loop this mistake. Use "Slow Motion" to see it in detail.
                </div>
            `;
            overlay.classList.add('active');
            
            // Hide annotation after 7 seconds
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 7000);
            
                currentClipIndex = index;
            } catch (e) {
                console.error('Error in playClip:', e);
                const statusDiv = document.getElementById('playerStatus');
                if (statusDiv) {
                    statusDiv.textContent = `Error playing clip: ${e.message}`;
                    statusDiv.className = 'player-status active error';
                }
            }
        }
        
        function setupReplayListeners() {
            console.log('Setting up replay listeners for method:', currentPlayerMethod);
            
            // Remove existing listeners to avoid duplicates
            if (currentPlayer) {
                try {
                    currentPlayer.removeEventListener('timeupdate', handleTimeUpdate);
                    currentPlayer.removeEventListener('ended', handleVideoEnded);
                } catch (e) {
                    console.log('Error removing native listeners:', e);
                }
            }
            
            // Remove Plyr listeners if applicable
            if (currentPlayerMethod === 'plyr' && plyrInstance) {
                try {
                    plyrInstance.off('timeupdate', handleTimeUpdate);
                    plyrInstance.off('ended', handleVideoEnded);
                } catch (e) {
                    console.log('Error removing Plyr listeners:', e);
                }
            }
            
            // Remove Video.js listeners if applicable
            if (currentPlayerMethod === 'videojs' && videojsInstance) {
                try {
                    videojsInstance.off('timeupdate', handleTimeUpdate);
                    videojsInstance.off('ended', handleVideoEnded);
                } catch (e) {
                    console.log('Error removing Video.js listeners:', e);
                }
            }
            
            // Add new listeners based on player type
            if (currentPlayer) {
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    // Use Plyr's event system
                    console.log('Adding Plyr replay listeners');
                    plyrInstance.on('timeupdate', handleTimeUpdate);
                    plyrInstance.on('ended', handleVideoEnded);
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    // Use Video.js event system
                    console.log('Adding Video.js replay listeners');
                    videojsInstance.on('timeupdate', handleTimeUpdate);
                    videojsInstance.on('ended', handleVideoEnded);
                } else {
                    // Use native HTML5 events
                    console.log('Adding native HTML5 replay listeners');
                    currentPlayer.addEventListener('timeupdate', handleTimeUpdate);
                    currentPlayer.addEventListener('ended', handleVideoEnded);
                }
            } else {
                console.warn('No currentPlayer available for replay listeners');
            }
        }
        
        let isLooping = false; // Prevent multiple simultaneous loops
        
        function handleTimeUpdate() {
            if (!currentPlayer || !isReplayMode) return;
            
            const currentTime = getCurrentTime();
            const duration = getDuration();
            
            if (duration === 0 || isNaN(duration) || duration === Infinity) return;
            
            // Show mistake marker at mistake timestamp (with a small window)
            const mistakeMarker = document.getElementById('mistakeMarker');
            if (mistakeMarker) {
                if (Math.abs(currentTime - mistakeTimestamp) < 0.2) {
                    mistakeMarker.classList.add('active');
                } else {
                    mistakeMarker.classList.remove('active');
                }
            }
            
            // Handle replay loop - check if we're very close to the end
            // Use a smaller threshold and prevent multiple loops
            const loopThreshold = 0.1; // Loop when within 0.1 seconds of end
            if (!isLooping && currentTime > 0 && duration > 0 && currentTime >= duration - loopThreshold) {
                isLooping = true; // Set flag to prevent multiple loops
                
                // Loop back to start
                seekTo(0);
                replayCount++;
                const replayCountEl = document.getElementById('replayCount');
                const replayInfoEl = document.getElementById('replayInfo');
                if (replayCountEl) replayCountEl.textContent = replayCount;
                if (replayInfoEl) replayInfoEl.classList.add('active');
                
                // Reset flag after a short delay
                setTimeout(() => {
                    isLooping = false;
                }, 500);
            }
        }
        
        function handleVideoEnded() {
            if (isReplayMode && currentPlayer && !isLooping) {
                isLooping = true; // Prevent multiple simultaneous loops
                
                // Loop back to start for replay
                seekTo(0);
                replayCount++;
                const replayCountEl = document.getElementById('replayCount');
                const replayInfoEl = document.getElementById('replayInfo');
                if (replayCountEl) replayCountEl.textContent = replayCount;
                if (replayInfoEl) replayInfoEl.classList.add('active');
                
                // Continue playing after a brief delay
                setTimeout(() => {
                    playVideo().catch(e => {
                        console.log('Replay play error:', e);
                    });
                    isLooping = false; // Reset flag
                }, 200);
            }
        }
        
        function getCurrentTime() {
            if (!currentPlayer) return 0;
            
            try {
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    return plyrInstance.currentTime || 0;
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    return videojsInstance.currentTime() || 0;
                } else if (currentPlayer && typeof currentPlayer.currentTime === 'number') {
                    return currentPlayer.currentTime;
                }
            } catch (e) {
                console.log('Error getting current time:', e);
            }
            return 0;
        }
        
        function getDuration() {
            if (!currentPlayer) return 0;
            
            try {
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    return plyrInstance.duration || 0;
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    return videojsInstance.duration() || 0;
                } else if (currentPlayer && typeof currentPlayer.duration === 'number') {
                    return currentPlayer.duration;
                }
            } catch (e) {
                console.log('Error getting duration:', e);
            }
            return 0;
        }
        
        function seekTo(time) {
            if (!currentPlayer) return;
            
            try {
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    plyrInstance.currentTime = time;
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    videojsInstance.currentTime(time);
                } else if (currentPlayer && typeof currentPlayer.currentTime !== 'undefined') {
                    currentPlayer.currentTime = time;
                }
            } catch (e) {
                console.log('Error seeking:', e);
            }
        }
        
        function playVideo() {
            if (!currentPlayer) return Promise.resolve();
            
            // Check if video is ready to play (only for native HTML5)
            if (currentPlayerMethod !== 'plyr' && currentPlayerMethod !== 'videojs') {
                if (currentPlayer.readyState !== undefined && currentPlayer.readyState < 2) {
                    console.log('Video not ready, waiting for loadeddata...');
                    return new Promise((resolve) => {
                        const handler = () => {
                            if (currentPlayer) {
                                currentPlayer.removeEventListener('loadeddata', handler);
                            }
                            resolve(playVideo());
                        };
                        if (currentPlayer) {
                            currentPlayer.addEventListener('loadeddata', handler, { once: true });
                        } else {
                            resolve(Promise.resolve());
                        }
                    });
                }
            }
            
            try {
                let playPromise;
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    playPromise = plyrInstance.play();
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    playPromise = videojsInstance.play();
                } else if (currentPlayer && typeof currentPlayer.play === 'function') {
                    playPromise = currentPlayer.play();
                } else {
                    return Promise.resolve();
                }
                
                return playPromise.catch(err => {
                    // Ignore AbortError - it's usually harmless (user interaction)
                    if (err && err.name !== 'AbortError') {
                        console.log('Play error:', err);
                    }
                    return Promise.resolve(); // Resolve instead of reject to prevent unhandled promise
                });
            } catch (e) {
                console.log('Play exception:', e);
                return Promise.resolve();
            }
        }
        
        window.toggleReplay = function() {
            if (!currentPlayer) {
                console.log('No video player available for replay');
                // Try to get current player
                const playerElement = document.getElementById('videoPlayer');
                if (playerElement) {
                    currentPlayer = playerElement;
                } else {
                    console.error('No video player element found');
                    return;
                }
            }
            
            isReplayMode = !isReplayMode;
            isLooping = false; // Reset loop flag
            
            if (isReplayMode) {
                replayCount = 0;
                const replayCountEl = document.getElementById('replayCount');
                const replayInfoEl = document.getElementById('replayInfo');
                const mistakeMarkerEl = document.getElementById('mistakeMarker');
                
                if (replayCountEl) replayCountEl.textContent = replayCount;
                if (replayInfoEl) replayInfoEl.classList.add('active');
                
                // Ensure listeners are set up
                setupReplayListeners();
                
                // Wait for video to be ready, then reset and play
                const tryStartReplay = () => {
                    const duration = getDuration();
                    if (duration > 0 && !isNaN(duration)) {
                        // Reset to start and play
                        seekTo(0);
                        
                        // Start playing after a brief delay
                        setTimeout(() => {
                            playVideo().catch(e => {
                                console.log('Replay play error:', e);
                            });
                        }, 200);
                    } else {
                        // Wait for video to load
                        if (currentPlayer) {
                            const handler = () => {
                                if (currentPlayer) {
                                    currentPlayer.removeEventListener('loadedmetadata', handler);
                                }
                                tryStartReplay();
                            };
                            currentPlayer.addEventListener('loadedmetadata', handler, { once: true });
                        }
                    }
                };
                
                tryStartReplay();
                
                console.log('Instant replay enabled');
            } else {
                const replayInfoEl = document.getElementById('replayInfo');
                const mistakeMarkerEl = document.getElementById('mistakeMarker');
                
                if (replayInfoEl) replayInfoEl.classList.remove('active');
                if (mistakeMarkerEl) mistakeMarkerEl.classList.remove('active');
                
                console.log('Instant replay disabled');
            }
            
            updateReplayButton();
        }
        
        window.toggleSlowMotion = function() {
            isSlowMotion = !isSlowMotion;
            
            if (!currentPlayer) return;
            
            try {
                const playbackRate = isSlowMotion ? 0.5 : 1.0;
                
                if (currentPlayerMethod === 'plyr' && plyrInstance) {
                    plyrInstance.speed = playbackRate;
                } else if (currentPlayerMethod === 'videojs' && videojsInstance) {
                    videojsInstance.playbackRate(playbackRate);
                } else {
                    currentPlayer.playbackRate = playbackRate;
                }
            } catch (e) {
                if (currentPlayer.playbackRate !== undefined) {
                    currentPlayer.playbackRate = isSlowMotion ? 0.5 : 1.0;
                }
            }
            
            updateSlowMoButton();
        }
        
        function updateReplayButton() {
            const btn = document.getElementById('replayBtn');
            if (btn) {
                if (isReplayMode) {
                    btn.classList.add('active');
                    btn.textContent = 'üîÑ Instant Replay (ON)';
                } else {
                    btn.classList.remove('active');
                    btn.textContent = 'üîÑ Instant Replay';
                }
            }
        }
        
        function updateSlowMoButton() {
            const btn = document.getElementById('slowMoBtn');
            if (btn) {
                if (isSlowMotion) {
                    btn.classList.add('active');
                    btn.textContent = '‚è±Ô∏è Slow Motion (ON)';
                } else {
                    btn.classList.remove('active');
                    btn.textContent = '‚è±Ô∏è Slow Motion';
                }
            }
        }
        
        // Initialize with all clips
        try {
            if (typeof window.filterClips === 'function') {
                window.filterClips('all', null);
            } else if (typeof filterClips === 'function') {
                filterClips('all', null);
            } else {
                console.error('filterClips function not found');
            }
        } catch (e) {
            console.error('Error initializing clips:', e);
            // Fallback: manually render clips if filterClips fails
            try {
                const container = document.getElementById('clipsContainer');
                if (container && clips && clips.length > 0) {
                    container.innerHTML = clips.map((clip, index) => {
                        const timestamp = formatTimestamp(clip.start_time);
                        return `<div class="clip-item" onclick="playClip(${index}, 'all')">
                            <div class="clip-header">
                                <span class="clip-time">${timestamp}</span>
                                <span class="clip-type">${clip.mistake_type}</span>
                            </div>
                            <div class="clip-description">${clip.description}</div>
                        </div>`;
                    }).join('');
                }
            } catch (fallbackError) {
                console.error('Fallback rendering also failed:', fallbackError);
            }
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error, e.filename, e.lineno);
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>
